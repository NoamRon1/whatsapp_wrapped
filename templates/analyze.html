<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Analyze - WhatsApp Wrapped</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

  <!-- Selection Screen -->
  <div id="selectionScreen" class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <h1 style="margin:0">Analyze uploaded chats</h1>
        <button id="themeToggle" class="theme-toggle" title="Toggle dark / light">ðŸŒ™</button>
    </div>

    <div class="card">
        <div class="search-row">
        <input id="search" placeholder="Search username..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd">
        <button id="refresh">Refresh</button>
        <button id="analyzeBtn" disabled>Analyze</button>
        <a href="/" style="margin-left:8px" class="small-muted">Back</a>
        </div>

        <!-- New: two selectors side-by-side -->
        <div class="selectors">
        <!-- left: username selector (unchanged behavior) -->
        <div class="selector-col">
            <div class="small-muted" style="margin-bottom:6px"><strong>Users</strong></div>
            <div class="username-list" id="userList">Loading...</div>
        </div>

        <!-- right: year selector implemented like the username selector (multi-select) -->
        <div class="selector-col">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
            <div class="small-muted"><strong>Years</strong></div>
            <div>
                <button id="clearYears" title="Clear year selection" class="small-muted" style="background:none;border:0;cursor:pointer">Clear</button>
            </div>
            </div>
            <div class="username-list" id="yearList">Loading...</div>
            <div class="small-muted" style="margin-top:6px;font-size:12px">Click to toggle years (multi-select)</div>
        </div>
        </div>
    </div>
  </div>

  <!-- Story / Wrapped View -->
  <div id="storyView" class="story-overlay" style="display:none">
    <button id="closeStory" class="close-btn">Ã—</button>

    <!-- Navigation Areas -->
    <div id="tapLeft" class="tap-area left"></div>
    <div id="tapRight" class="tap-area right"></div>

    <div class="story-content">

        <!-- Slide 1: Intro -->
        <div class="slide active" id="slide-1">
            <div class="slide-body centered">
                <h1 class="animate-pop">Let's unwind your chat history...</h1>
                <p class="subtitle animate-fade">Analysis for <span id="selUser">User</span></p>
                <div class="small-hint">Tap to continue</div>
            </div>
        </div>

        <!-- Slide 2: Overview -->
        <div class="slide" id="slide-2">
            <div class="slide-header">The Basics</div>
            <div class="slide-body">
                <h2 class="headline">You were quite the chatterbox.</h2>
                <div class="big-stat">
                    <span id="sentCount" class="highlight">0</span>
                    <span class="label">Messages Sent</span>
                </div>
                <div class="big-stat">
                    <span id="recvCount" class="highlight">0</span>
                    <span class="label">Messages Received</span>
                </div>
                <div class="stat-row">
                    <span>In <strong id="chatsCount">0</strong> chats</span>
                </div>
            </div>
        </div>

        <!-- Slide 3: Timing -->
        <div class="slide" id="slide-3">
            <div class="slide-header">Timing</div>
            <div class="slide-body">
                <h2 class="headline" id="timeHeadline">You have a rhythm.</h2>
                <div class="big-stat">
                    <span id="activeHour" class="highlight">00:00</span>
                    <span class="label">Most Active Hour</span>
                </div>
                <div class="stat-box">
                    <p>Your favorite day was <strong id="activeWeekday" class="accent-text">Monday</strong></p>
                </div>
                <div class="stat-row">
                   Late night messages: <strong id="lateNightCount">0</strong>
                </div>
            </div>
        </div>

        <!-- Slide 4: Habits -->
        <div class="slide" id="slide-4">
            <div class="slide-header">Habits</div>
            <div class="slide-body">
                <h2 class="headline">Consistency is key.</h2>
                <div class="grid-stats">
                    <div class="grid-item">
                        <span id="activeDays" class="number">0</span>
                        <span class="sub">Active Days</span>
                    </div>
                    <div class="grid-item">
                        <span id="avgPerDay" class="number">0</span>
                        <span class="sub">Msgs/Day</span>
                    </div>
                </div>
                <div class="stat-box mt-4">
                    <p>Usually, you reply in</p>
                    <h3 id="avgReply" class="accent-text">0 sec</h3>
                </div>
            </div>
        </div>

        <!-- Slide 5: Emojis -->
        <div class="slide" id="slide-5">
            <div class="slide-header">Expressions</div>
            <div class="slide-body centered">
                <h2 class="headline">Your emotional support emoji</h2>
                <div id="emotionalEmojiDisplay" class="giant-emoji">ðŸ˜Š</div>
                <p class="subtitle" id="emotionalEmojiCount">Used 0 times</p>

                <div class="top-list mt-4">
                    <p>Runners up:</p>
                    <div id="topEmojis" class="emoji-row"></div>
                </div>
            </div>
        </div>

        <!-- Slide 6: Voice -->
        <div class="slide" id="slide-6">
            <div class="slide-header">Voice</div>
            <div class="slide-body">
                <h2 class="headline">Mic check... 1, 2.</h2>
                <div class="big-stat">
                    <span id="voiceCount" class="highlight">0</span>
                    <span class="label">Voice Notes</span>
                </div>
                <div class="stat-row">
                    Totaling <strong id="voiceHours">0.0</strong> hours of talking.
                </div>
            </div>
        </div>

        <!-- Slide 7: Streaks -->
        <div class="slide" id="slide-7">
            <div class="slide-header">Streaks & Peaks</div>
            <div class="slide-body">
                <h2 class="headline">You couldn't stop talking!</h2>
                <div class="big-stat">
                    <span id="longestStreak" class="highlight">0</span>
                    <span class="label">Days Streak</span>
                </div>
                <div class="small-hint" id="longestStreakRange"></div>

                <div class="stat-box mt-4">
                    <p>Busiest Day: <strong id="busiestDay"></strong></p>
                </div>
            </div>
        </div>

         <!-- Slide 8: Words -->
         <div class="slide" id="slide-8">
            <div class="slide-header">Vocabulary</div>
            <div class="slide-body">
                <h2 class="headline">What you talked about</h2>
                <div id="wordCloud" class="word-cloud-container">
                    <img id="wordCloudImg" alt="word cloud" style="max-width:100%;height:auto;display:none" />
                </div>
                <div id="topWordsInline" class="small-text mt-2"></div>
            </div>
        </div>

        <!-- Slide 9: Groups & Friends -->
        <div class="slide" id="slide-9">
            <div class="slide-header">The Crew</div>
            <div class="slide-body">
                <h2 class="headline">Squad Goals</h2>
                <div class="stat-box">
                    <p>Most active group:</p>
                    <h3 id="groupMostMsgs" class="accent-text">Group</h3>
                </div>

                <div class="top-list mt-4">
                    <p>Top Chatterboxes:</p>
                    <div id="topSenders" class="list-container"></div>
                </div>
            </div>
        </div>

        <!-- Slide 10: Summary -->
        <div class="slide" id="slide-10">
            <div class="slide-body centered">
                <h1 class="animate-pop">That's a wrap!</h1>
                <p>See you next year?</p>
                <button id="replayBtn" class="big-btn">Replay</button>
                <button id="downloadStats" class="secondary-btn mt-2">Download JSON</button>
            </div>
             <pre id="rawStats" style="display:none"></pre>
        </div>

    </div>

    <!-- Progress Bars -->
    <div class="progress-container">
        <div class="progress-bar active"></div>
        <div class="progress-bar"></div>
        <div class="progress-bar"></div>
        <div class="progress-bar"></div>
        <div class="progress-bar"></div>
        <div class="progress-bar"></div>
        <div class="progress-bar"></div>
        <div class="progress-bar"></div>
        <div class="progress-bar"></div>
        <div class="progress-bar"></div>
    </div>
  </div>


<script>
  let usernames = [];
  let filtered = [];
  let selected = null;
  const userList = document.getElementById('userList');
  const yearList = document.getElementById('yearList');
  const search = document.getElementById('search');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const refreshBtn = document.getElementById('refresh');
  const selUserEl = document.getElementById('selUser');

  // Story elements
  const selectionScreen = document.getElementById('selectionScreen');
  const storyView = document.getElementById('storyView');
  const slides = document.querySelectorAll('.slide');
  const progressBars = document.querySelectorAll('.progress-bar');
  let currentSlide = 0;

  // track selected years as a Set for multi-select
  const selectedYears = new Set();

  function loadUsernames(){
    userList.textContent = 'Loading...';
    fetch('/api/usernames').then(r=>r.json()).then(j=>{
      usernames = j.usernames || [];
      filtered = usernames.slice();
      renderList();
    }).catch(e=>{
      userList.textContent = 'Failed to load usernames';
    });
  }

  function renderList(){
    if(filtered.length === 0){
      userList.innerHTML = '<div class="small-muted">No usernames found</div>';
      return;
    }
    userList.innerHTML = '';
    filtered.forEach(n=>{
      const div = document.createElement('div');
      div.className = 'username-item';
      div.textContent = n;
      div.onclick = ()=> {
        document.querySelectorAll('#userList .username-item').forEach(el=>el.style.background='');
        div.style.background='#eef6ff';
        selected = n;
        analyzeBtn.disabled = false;
      };
      userList.appendChild(div);
    });
  }

  search.addEventListener('input', ()=>{
    const q = search.value.trim().toLowerCase();
    filtered = usernames.filter(n => n.toLowerCase().includes(q));
    renderList();
  });

  // populate yearList with clickable items (multi-select)
  function loadYears(){
    yearList.textContent = 'Loading...';
    fetch('/api/years').then(r=>r.json()).then(j=>{
      const years = j.years || [];
      if(years.length === 0){
        yearList.innerHTML = '<div class="small-muted">No years found</div>';
        return;
      }
      yearList.innerHTML = '';
      years.forEach(y=>{
        const div = document.createElement('div');
        div.className = 'username-item year-item';
        div.textContent = y;
        div.dataset.year = y;
        div.onclick = ()=> {
          const year = div.dataset.year;
          if(selectedYears.has(year)){
            selectedYears.delete(year);
            div.style.background = '';
          } else {
            selectedYears.add(year);
            div.style.background = '#eef6ff';
          }
        };
        yearList.appendChild(div);
      });
    }).catch(e=>{
      yearList.textContent = 'Failed to load years';
    });
  }

  document.getElementById('clearYears').addEventListener('click', ()=>{
    selectedYears.clear();
    document.querySelectorAll('#yearList .year-item').forEach(el=>el.style.background='');
  });

  analyzeBtn.addEventListener('click', ()=>{
    if(!selected) return;
    selUserEl.textContent = selected;

    const chosen = Array.from(selectedYears);
    const params = new URLSearchParams();
    params.set('user', selected);
    if(chosen.length){
      params.set('years', chosen.join(','));
    }

    // Show loading or disable button
    analyzeBtn.textContent = "Crunching numbers...";
    analyzeBtn.disabled = true;

    fetch('/api/stats?' + params.toString()).then(r=>r.json()).then(j=>{
      // Populate Data
      populateStats(j, selected, chosen);

      // Switch to story view
      selectionScreen.style.display = 'none';
      storyView.style.display = 'block';
      currentSlide = 0;
      updateSlide();

      analyzeBtn.textContent = "Analyze";
      analyzeBtn.disabled = false;

    }).catch(e=>{
      alert('Failed to compute stats');
      analyzeBtn.textContent = "Analyze";
      analyzeBtn.disabled = false;
      console.error(e);
    });
  });

  function populateStats(j, user, yearsArray) {
      // Overview
      document.getElementById('sentCount').textContent = j.total_messages_sent;
      document.getElementById('recvCount').textContent = j.total_messages_received;
      document.getElementById('chatsCount').textContent = j.total_chats_participated_in;

      // Reply stats
      document.getElementById('avgReply').textContent = j.overall_avg_reply_seconds ? (Math.round(j.overall_avg_reply_seconds)) + ' sec' : 'n/a';

      // Activity
      document.getElementById('activeDays').textContent = j.total_active_days;
      document.getElementById('avgPerDay').textContent = Math.round((j.avg_messages_per_day||0)*100)/100;

      // Time
      document.getElementById('activeHour').textContent = j.most_active_hour !== null ? (j.most_active_hour + ':00') : 'n/a';
      // Headline logic for time
      if(j.most_active_hour !== null) {
          const h = j.most_active_hour;
          let label = "Day";
          if(h >= 5 && h < 12) label = "Morning";
          else if(h >= 12 && h < 18) label = "Afternoon";
          else if(h >= 18 && h < 22) label = "Evening";
          else label = "Night";
          document.getElementById('timeHeadline').textContent = `You are a ${label} person.`;
      }

      const weekdays = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      document.getElementById('activeWeekday').textContent = j.most_active_day_of_week !== null ? weekdays[j.most_active_day_of_week] : 'n/a';

      // Emoji
      const es = j.emoji_stats || {};
      if(es.most_used){
        document.getElementById('emotionalEmojiDisplay').textContent = es.most_used.emoji;
        document.getElementById('emotionalEmojiCount').textContent = `Used ${es.most_used.count} times`;
      } else {
        document.getElementById('emotionalEmojiDisplay').textContent = 'ðŸ˜';
        document.getElementById('emotionalEmojiCount').textContent = 'No emojis found';
      }
      const topEl = document.getElementById('topEmojis');
      topEl.textContent = (es.top_5 || []).slice(1).map(e=> `${e.emoji}`).join('  '); // Skip first as it's the main one

      // Voice
      const vs = j.voice_stats || {};
      const secs = vs.voice_total_seconds || 0;
      const hours = Math.round((secs/3600)*10)/10;
      document.getElementById('voiceCount').textContent = vs.voice_messages_count || 0;
      document.getElementById('voiceHours').textContent = hours;

      // Streaks
      document.getElementById('lateNightCount').textContent = j.late_night_messages_count ?? 0;

      const ls = j.longest_daily_streak;
      if(ls){
        document.getElementById('longestStreak').textContent = ls.streak || 0;
        const range = (ls.start ? ls.start : '') + (ls.end ? (' â€” ' + ls.end) : '');
        document.getElementById('longestStreakRange').textContent = range;
      } else {
        document.getElementById('longestStreak').textContent = '0';
        document.getElementById('longestStreakRange').textContent = '';
      }

      const bd = j.busiest_single_day;
      document.getElementById('busiestDay').textContent = bd ? `${bd.date} (${bd.count} msgs)` : 'n/a';

      // Word Cloud
      const ws = j.word_stats || {};
      requestWordCloudFromServer(user, yearsArray, ws.top_words || []);
      // Text fallback
      document.getElementById('topWordsInline').textContent = (ws.top_words || []).slice(0,10).map(w=> w.word).join(', ');

      // Groups
      const gm = j.group_most_messages;
      document.getElementById('groupMostMsgs').textContent = gm ? `${gm.chat} (${gm.count})` : 'n/a';

      // Top Senders
      const topEl2 = document.getElementById('topSenders');
      topEl2.innerHTML = '';
      (j.top_senders || []).slice(0,5).forEach((t, index)=>{
        const r = document.createElement('div');
        r.className = 'top-sender-item';
        r.textContent = `#${index+1} ${t.name} (${t.count})`;
        topEl2.appendChild(r);
      });

      // Raw for download
      document.getElementById('rawStats').textContent = JSON.stringify(j, null, 2);
  }

  // --- Story Navigation ---
  function updateSlide() {
      slides.forEach((s, i) => {
          if (i === currentSlide) {
            s.classList.add('active');
            s.style.display = 'block';
          } else {
            s.classList.remove('active');
            s.style.display = 'none';
          }
      });
      progressBars.forEach((p, i) => {
          if (i <= currentSlide) p.classList.add('filled');
          else p.classList.remove('filled');
      });
  }

  function nextSlide() {
      if (currentSlide < slides.length - 1) {
          currentSlide++;
          updateSlide();
      } else {
        // End of story
        // Maybe loop back or show close button emphasis?
      }
  }

  function prevSlide() {
      if (currentSlide > 0) {
          currentSlide--;
          updateSlide();
      }
  }

  document.getElementById('tapRight').addEventListener('click', nextSlide);
  document.getElementById('tapLeft').addEventListener('click', prevSlide);

  // Keyboard nav
  document.addEventListener('keydown', (e) => {
      if(storyView.style.display === 'none') return;
      if(e.key === 'ArrowRight' || e.key === ' ') nextSlide();
      if(e.key === 'ArrowLeft') prevSlide();
      if(e.key === 'Escape') closeStory();
  });

  function closeStory() {
      storyView.style.display = 'none';
      selectionScreen.style.display = 'block';
  }

  document.getElementById('closeStory').addEventListener('click', closeStory);
  document.getElementById('replayBtn').addEventListener('click', () => {
      currentSlide = 0;
      updateSlide();
  });


  refreshBtn.addEventListener('click', ()=> { loadUsernames(); loadYears(); });

  document.getElementById('downloadStats').addEventListener('click', ()=>{
    const text = document.getElementById('rawStats').textContent;
    if(!text) return;
    const blob = new Blob([text], {type: 'application/json;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `stats_${(new Date()).toISOString().replace(/[:.]/g,'_')}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  function formatDuration(seconds){
    if(!seconds || seconds <= 0) return '0s';
    if(seconds >= 3600) return (Math.round((seconds/3600)*10)/10) + 'h';
    if(seconds >= 60) return Math.round(seconds/60) + 'm';
    return Math.round(seconds) + 's';
  }

  // request server-side word cloud; fallbackTopWords used if image generation/fetch fails
  function requestWordCloudFromServer(user, yearsArray, fallbackTopWords){
    const params = new URLSearchParams();
    params.set('user', user);
    if(yearsArray && yearsArray.length) params.set('years', yearsArray.join(','));
    const imgEl = document.getElementById('wordCloudImg');
    // hide img while loading
    imgEl.style.display = 'none';
    fetch('/api/wordcloud.png?' + params.toString()).then(r=>{
      if(!r.ok) throw r;
      return r.blob();
    }).then(blob=>{
      const url = URL.createObjectURL(blob);
      // revoke previous src if any
      if(imgEl._currentUrl) URL.revokeObjectURL(imgEl._currentUrl);
      imgEl._currentUrl = url;
      imgEl.src = url;
      imgEl.style.display = 'block';
    }).catch(err=>{
      // fallback to client-side rendering using fallbackTopWords
      // clear any img
      imgEl.style.display = 'none';
      // use previous client-side render function (keeps behavior)
      renderWordCloudFallback(fallbackTopWords || []);
    });
  }

  // keep an inline fallback renderer for cases where server image is not available
  function renderWordCloudFallback(topWords){
    const area = document.getElementById('wordCloud');
    // remove any existing img display (we hide image in caller)
    // render spans as before
    // clear previous non-img children
    Array.from(area.querySelectorAll('.wc-word')).forEach(n=>n.remove());
    if(!topWords || topWords.length===0){
        // Do nothing or show placeholder
      return;
    }
    const counts = topWords.map(w=>w.count);
    const minC = Math.min(...counts), maxC = Math.max(...counts);
    const minSize = 14, maxSize = 36;
    function sizeForCount(c){
      if(maxC === minC) return (minSize+maxSize)/2;
      return Math.round(minSize + (c - minC) / (maxC - minC) * (maxSize - minSize));
    }
    topWords.forEach(w=>{
      const sp = document.createElement('span');
      sp.className = 'wc-word';
      sp.textContent = w.word;
      sp.title = `${w.word} Ã—${w.count}`;
      sp.style.fontSize = sizeForCount(w.count) + 'px';
      sp.style.margin = '4px';
      sp.style.display = 'inline-block';
      area.appendChild(sp);
    });
  }

  // initial load
  loadUsernames();
  loadYears();
</script>

<script>
  // Theme logic
  (function(){
    const key = 'wh_wrapped_theme';
    const btn = document.getElementById('themeToggle');
    function applyTheme(theme){
      document.documentElement.classList.toggle('dark', theme === 'dark');
      btn.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
    }
    function getStored(){
      try { return localStorage.getItem(key) || null } catch(e){ return null }
    }
    function setStored(v){
      try { localStorage.setItem(key, v) } catch(e){}
    }
    const stored = getStored();
    if(stored) applyTheme(stored);
    else {
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }
    btn.addEventListener('click', ()=>{
      const now = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
      applyTheme(now);
      setStored(now);
    });
  })();
</script>

</body>
</html>
